{
  "application": "ml-training-pipelines",
  "keepWaitingPipelines": false,
  "limitConcurrent": true,
  "name": "internaltools-production-chef-rollback",
  "notifications": [],
  "parameterConfig": [
    {
      "default": "",
      "description": "Version of the App to deploy e.g. \"v23\". To deploy your branch use branch name without \"-deploy\" suffix e.g. \"jdoe.feature-branch-name\"",
      "hasOptions": false,
      "name": "gitRef",
      "pinned": true,
      "required": true
    }
  ],
  "stages": [
    {
      "completeOtherBranchesThenFail": false,
      "continuePipeline": false,
      "failPipeline": true,
      "gitRef": "${parameters.gitRef}",
      "instructions": "This is a buddy check. It requires user approval for the pipeline to continue.\n\nThis pipeline will deploy \u003cb\u003e${ trigger['parameters']['gitRef'] }\u003c/b\u003e\n\n\u003ca href=${ trigger['parameters']['gitRef'] == \"master\" || trigger['parameters']['gitRef'] == \"main\" ? \"https://github.com/zendesk/ml-training-pipelines\" : trigger['parameters']['gitRef'] matches \"v(\\d+)[\\.\\d+]*\" ? \"https://github.com/zendesk/ml-training-pipelines/releases/${trigger['parameters']['gitRef']}\" : \"https://github.com/zendesk/ml-training-pipelines/commits/${trigger['parameters']['gitRef']}\"}\u003e View ${trigger['parameters']['gitRef']}\u003c/a\u003e\n",
      "name": "Buddy",
      "notifications": [],
      "refId": "buddy",
      "requisiteStageRefIds": [],
      "sendNotifications": true,
      "type": "buddy"
    },
    {
      "application": "ml-training-pipelines",
      "comments": "\u003cdiv style=\"padding: 15px; margin-bottom: 5px;\"\u003e\n    \u003cdiv class=\"row\"\u003e\n        \u003cdiv class=\"col-md-12\"\u003e\n            \u003cdl class=\"dl-horizontal\"\u003e\n                \u003cdiv\u003e\n                    \u003cdt\u003eDeployment Status\u003c/dt\u003e\n                    \u003cdd\u003e\n                        \u003ca href=\"https://zendesk.datadoghq.com/orchestration/overview/deployment?tags=kube_app_name%3Aml-training-pipelines%2Ckube_cluster_name%3Ainternaltools-production-use1-chef\"\u003eDeployment Status\u003c/a\u003e\n                    \u003c/dd\u003e\n                \u003c/div\u003e\n            \u003c/dl\u003e\n        \u003c/div\u003e\n    \u003c/div\u003e\n\u003c/div\u003e\n",
      "completeOtherBranchesThenFail": false,
      "continuePipeline": true,
      "failPipeline": false,
      "name": "internaltools-production-use1-chef",
      "pipeline": "${#pipelineId(\"internaltools-production-use1-chef\")}",
      "pipelineParameters": {
        "gitRef": "${ trigger.parameters.gitRef }",
        "rollback": "true"
      },
      "refId": "internaltools-production-use1-chef",
      "requisiteStageRefIds": [
        "buddy"
      ],
      "skipDownstreamOutput": true,
      "type": "pipeline",
      "waitForCompletion": true
    },
    {
      "completeOtherBranchesThenFail": false,
      "continuePipeline": false,
      "failPipeline": false,
      "name": "Rollback succeeded",
      "preconditions": [
        {
          "context": {
            "expression": "${ #stageByRefId(\"internaltools-production-use1-chef\").status == \"SUCCEEDED\" }",
            "failureMessage": "One of the previous steps failed"
          },
          "failPipeline": true,
          "type": "expression"
        }
      ],
      "refId": "rollback-succeeded",
      "requisiteStageRefIds": [
        "internaltools-production-use1-chef"
      ],
      "type": "checkPreconditions"
    },
    {
      "completeOtherBranchesThenFail": false,
      "continuePipeline": false,
      "failPipeline": false,
      "name": "Rollback failed",
      "preconditions": [
        {
          "context": {
            "expression": "${ #stageByRefId(\"internaltools-production-use1-chef\").status == \"FAILED_CONTINUE\" }",
            "failureMessage": "One of the previous steps failed"
          },
          "failPipeline": false,
          "type": "expression"
        }
      ],
      "refId": "rollback-failed",
      "requisiteStageRefIds": [
        "internaltools-production-use1-chef"
      ],
      "type": "checkPreconditions"
    },
    {
      "completeOtherBranchesThenFail": false,
      "continuePipeline": false,
      "failPipeline": true,
      "name": "Report Failure",
      "preconditions": [
        {
          "context": {
            "expression": "false",
            "failureMessage": "Pipeline execution halted; see execution details for further information\n"
          },
          "failPipeline": true,
          "type": "expression"
        }
      ],
      "refId": "report-failure",
      "requisiteStageRefIds": [
        "rollback-failed"
      ],
      "type": "checkPreconditions"
    }
  ],
  "triggers": []
}